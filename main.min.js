var cols,rows,gridContainer,typesContainer,greenGroup,dragGroup,app,w=80,grid=[],types=[],colorArray=[32768,16766720,14423100,255],picArray=[0,1,2,3],targetMC=new Object,score=0,combo=0;function init(){app=new PIXI.Application(400,400,{backgroundColor:0}),document.getElementById("container").appendChild(app.view),app.stage=new PIXI.display.Stage,app.stage.group.enableSort=!0,cols=Math.floor(app.screen.width/w),rows=Math.floor(app.screen.height/w),gridContainer=new PIXI.Container,typesContainer=new PIXI.Container,app.stage.addChild(gridContainer),app.stage.addChild(typesContainer),greenGroup=new PIXI.display.Group(0,!0),dragGroup=new PIXI.display.Group(2,!1);for(var e=0;e<rows;e++)for(var t=0;t<cols;t++){var r=new Cell(t,e);gridContainer.addChild(r),grid.push(r)}app.ticker.add(function(e){for(var t=0;t<rows;t++);}),createBox(),app.stage.addChild(new PIXI.display.Layer(greenGroup)),app.stage.addChild(new PIXI.display.Layer(dragGroup))}function createBox(){types=[];for(var e=0;e<rows;e++)for(var t=0;t<cols;t++){var r=new Box(t,e);typesContainer.addChild(r),types.push(r)}}function Cell(e,t){var r=new PIXI.Container;r.i=e,r.j=t,r.id=index(e,t),r.type=Math.floor(4*Math.random());var n=new PIXI.Graphics;n.beginFill(14277081,1),n.drawRect(0,0,w,w),r.addChild(n);t=new PIXI.Text(index(e,t)+","+r.type);t.x=0,t.y=0;t=r.i*w;r.x=t;t=r.j*w;return r.y=t,r}function Box(d,s){var e=new PIXI.Container;e.i=d,e.j=s,e.id=index(d,s),e.type=grid[index(d,s)].type;var t=PIXI.Texture.from("p"+picArray[e.type]+".png"),t=new PIXI.Sprite(t);e.addChild(t);t=grid[index(d,s)];return e.x=t.x,e.y=t.y,e.interactive=!0,e.buttonMode=!0,e.parentGroup=greenGroup,e.on("pointerdown",onDragStart).on("pointerup",onDragEnd).on("pointerupoutside",onDragEnd).on("pointermove",onDragMove),e.on("mousedown",onDragStart),e.checkNeighbors=function(){var e=[],t=[],r=this.type,n=types[index(d,s-1)],a=types[index(d+1,s)],i=types[index(d,s+1)],o=types[index(d-1,s)],p=!1;return n&&n.type==r&&e.push(n),a&&a.type==r&&t.push(a),i&&i.type==r&&e.push(i),o&&o.type==r&&t.push(o),1<e.length&&(score++,n.alpha=0,i.alpha=0,p=!(this.alpha=0)),1<t.length&&(score++,o.alpha=0,a.alpha=0,p=!(this.alpha=0)),p},e}function index(e,t){return e<0||t<0||cols-1<e||rows-1<t?-1:e+t*cols}function onClick(){this.alpha=0}function onDragStart(e){this.data=e.data,this.parentGroup=dragGroup,this.dragging=!0,dragMC(this)}function onDragEnd(){this.dragging=!1,this.data=null,combo=0,$("#mask").show(),deleteAll("drag"),reCheck()}function reCheck(){checkScreen()?(checkAll(),combo++):$("#mask").hide(),$("#score").text(score),$("#combo").text(combo)}function onDragMove(){var e;this.dragging&&(e=this.data.getLocalPosition(this.parent),this.x=e.x-w/2,this.y=e.y-w/2,this.y>targetMC.y+w/2?null!=targetMC.bottom&&replaceMC(targetMC,targetMC.bottom):this.y<targetMC.y-w/2?null!=targetMC.top&&replaceMC(targetMC,targetMC.top):this.x>targetMC.x+w/2?null!=targetMC.right&&replaceMC(targetMC,targetMC.right):this.x<targetMC.x-w/2&&null!=targetMC.left&&replaceMC(targetMC,targetMC.left))}function replaceMC(e,t){TweenLite.to(t,.1,{x:e.x,y:e.y}),savei=t.i,savej=t.j;var r=types[index(e.i,e.j)].id;types[index(e.i,e.j)].id=types[index(t.i,t.j)].id,types[index(t.i,t.j)].id=r,types.sort(function(e,t){return e.id-t.id});for(var n=0;n<rows;n++)for(var a=0;a<cols;a++)types[index(a,n)].i=a,types[index(a,n)].j=n,grid[index(a,n)].type=types[index(a,n)].type;dragMC(types[index(savei,savej)])}function dragMC(e){var t=e.i,r=e.j,n=types[index(t,r-1)],a=types[index(t+1,r)],i=types[index(t,r+1)],o=types[index(t-1,r)];targetMC.top=n||null,targetMC.right=a||null,targetMC.bottom=i||null,targetMC.left=o||null,targetMC.type=e.type,targetMC.x=t*w,targetMC.y=r*w,targetMC.i=t,targetMC.j=r}function checkScreen(){var e=!1;for(i=0;i<types.length;i++)types[i].checkNeighbors()&&(e=!0);return e}function checkAll(){for(var e=0;e<cols;e++){for(var t=[],r=0;r<rows;r++){var n=types[index(e,r)];0==n.alpha?t.unshift(n):t.push(n)}newplace(t,e)}TweenLite.to({myProp:0},1.5,{myProp:100,onComplete:deleteAll,onCompleteParams:["recheck"]})}function newplace(e,t){for(i=0;i<e.length;i++){var r,n,a=e[i];0==a.alpha&&(a.y=(rows-i)*-w-w,a.alpha=1,r=Math.floor(4*Math.random()),a.removeChild(a.children[0]),n=PIXI.Texture.from("p"+picArray[r]+".png"),n=new PIXI.Sprite(n),a.type=r,a.addChild(n)),console.log(i),grid[index(t,i)].type=a.type,TweenLite.to(a,.5,{y:w*i,delay:.5})}}function deleteAll(e){for(i=0;i<cols*rows;i++)typesContainer.removeChild(typesContainer.children[0]);createBox(),"recheck"==e&&reCheck()}$().ready(function(){init()});